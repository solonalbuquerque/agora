# AGORA Core — environment template
# Copy to .env and adjust values. Do not commit .env.

# HTTP port for the API (default 3000)
PORT=3000

# PostgreSQL connection string (required)
# Format: postgres://user:password@host:port/database
DATABASE_URL=postgres://agora:agora@localhost:5432/agora

# Redis connection URL (optional; used for rate limit, nonce store)
# Format: redis://host:port
REDIS_URL=redis://localhost:6379

# Admin token for POST /admin/mint and /admin/issuers (required for admin operations)
ADMIN_TOKEN=

# Staff area: /staff routes and UI (default false). When true, use STAFF_PASSWORD and optionally STAFF_TOKEN.
ENABLE_STAFF=false
STAFF_PASSWORD=
STAFF_TOKEN=
STAFF_JWT_SECRET=
STAFF_2FA_ENABLED=false
STAFF_2FA_FORCED=false
# Optional: fallback TOTP secret. Normally the secret is stored in the DB when 2FA is set up in the app (POST /staff/2fa/setup).
STAFF_2FA_SECRET=

# Default coin symbol (default AGOTEST)
DEFAULT_COIN=AGOTEST

# Reserved coin (AGO): local mint/faucet blocked; outbound and issuer credit gated by compliance (default AGO)
RESERVED_COIN=AGO

# Optional: instance ID for this deployment (compliance/manifest). If unset, first instance row is used.
# INSTANCE_ID=

# URL of the AGORA-CENTER (Central) — connection endpoint for registration, activation, and sync. Exposed in manifest when set.
# DEV:  https://dev.agoracenter.diia.com.br
# PROD: https://agoracenter.diia.com.br
AGORA_CENTER_URL=https://dev.agoracenter.diia.com.br
# Alternative name (same effect): CENTRAL_URL=

# Enable self-host faucet: POST /faucet (default false)
ENABLE_FAUCET=false

# Human (email) flow: return verification token in POST /human/register response for dev (default false)
HUMAN_EMAIL_DEV_RETURN_TOKEN=false

# JWT secret for human sessions (optional; if set, /human/me and /human/me/agents require Bearer token)
HUMAN_JWT_SECRET=

# Allow linking agent with agent_secret in body for self-host (default false; use challenge/response otherwise)
ALLOW_INSECURE_LINK=false
# Allow localhost/private IPs for webhook URLs when creating services via staff panel (dev only; default false)
ALLOW_INSECURE_WEBHOOK=false

# Webhook request (background): timeout in seconds before closing the socket (default 600 = 10 min)
EXECUTE_PENDING_MAX_SEC=600
# Public base URL for X-Url-Callback and manifest (e.g. https://api.agora.example.com). Defaults to http://localhost:PORT.
AGORA_PUBLIC_URL=

# Service export: staff setting "Enable Service Export" (default false). When true, agents can mark services as exported.
# Stored in DB (staff_settings.export_services_enabled); no env default except migration seed false.

# --- B1 Security & Antiabuse ---
# Rate limiting (Redis with in-memory fallback): window in seconds and max requests per window per key (agent/issuer/IP).
RATE_LIMIT_WINDOW_SECONDS=60
RATE_LIMIT_MAX_REQUESTS=100
# Webhook hardening: timeout in ms for outbound webhook call, max request/response body size in bytes.
SERVICE_WEBHOOK_TIMEOUT_MS=30000
SERVICE_WEBHOOK_MAX_BYTES=1048576
# Circuit breaker: after N consecutive webhook failures, service is paused (POST /admin/services/:id/resume to resume).
SERVICE_CB_FAILS=5
# HMAC replay protection: timestamp tolerance in seconds (reject if outside window; reject duplicate signatures).
HMAC_TOLERANCE_SECONDS=300

# --- B2 Observability & Audit ---
# Request correlation: X-Request-Id on all responses and in logs (always on).
# Metrics: Prometheus-style GET /metrics (default false).
ENABLE_METRICS=false
# Retention: cleanup script removes data older than N days (0 = do not remove).
EXECUTION_RETENTION_DAYS=0
AUDIT_RETENTION_DAYS=0


# Reserved coin (AGO): local mint/faucet blocked; outbound and issuer credit gated by compliance (default AGO)
RESERVED_COIN=AGO

# Optional: instance ID for this deployment (compliance/manifest). If unset, first instance row is used.
INSTANCE_ID=

# AGORA_CENTER_URL=https://dev.agoracenter.diia.com.br

# ── Novo modelo operacional: Pull Worker + Resolver ───────────────────────────

# Token de ativação da instância (obtido em POST /instances/activate na CENTRAL)
# INSTANCE_TOKEN=
# Alternativo: AGORA_INSTANCE_TOKEN=

# Secret que a CENTRAL envia em X-Central-Secret ao chamar execute-from-central (modo DIRECT)
# Deve coincidir com CENTRAL_EXECUTE_SECRET na CENTRAL
# AGORA_CENTER_EXECUTE_SECRET=change-me-execute-secret

# Modo de conectividade desta instância:
#   pull   = sem endpoint público (NAT/CGNAT) → usa pull worker
#   direct = tem endpoint público acessível → caller chama diretamente
# AGORA_CONNECTIVITY_MODE=pull

# Habilita o pull worker (obrigatório para receber execuções remotas no modo pull)
# INSTANCE_ENABLE_PULL_WORKER=true

# Máximo de jobs executados simultaneamente pelo pull worker
# EXEC_PULL_CONCURRENCY=3

# Intervalo em ms entre polls do pull worker
# EXEC_PULL_POLL_MS=5000

# Intervalo em ms para envio de heartbeat estendido para a CENTRAL
# CENTRAL_HEARTBEAT_INTERVAL_MS=60000

# TTL em segundos para cache do resolver (GET /public/resolve)
# RESOLVER_TTL_SECONDS=60
